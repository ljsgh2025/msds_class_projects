---
title: "COVID-19 RMD FINAL EDIT"
author: "LS"
date: "2025-11-28"
output:
  pdf_document: default
  html_document: default
---
## Read in and clean data

Here we read in the data provided in class. I will be using both `library(tidyverse)` and `library(lubridate)` we used both of these in class so I hope everyone will be OK.

```{r setup, echo = TRUE}
library(tidyverse)
library(lubridate)

url_in = "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/"

file_names = c("time_series_covid19_confirmed_US.csv",
               "time_series_covid19_confirmed_global.csv", 
               "time_series_covid19_deaths_US.csv",  
               "time_series_covid19_deaths_global.csv")

urls = str_c(url_in, file_names)

global_cases = read_csv(urls[2])
global_deaths = read.csv(urls[4])
US_cases = read.csv(urls[1])
US_deaths = read.csv(urls[3])
```

Cleaning up the global data as we did in class.
```{r global clean, echo=TRUE}
global_cases = global_cases %>%
    pivot_longer(cols = -c('Province/State', 'Country/Region', Lat, Long),
                 names_to = "date",
                 values_to = "cases") %>%
    select(-c(Lat, Long)) %>%
    mutate(date = mdy(date))

global_deaths = global_deaths %>%
  rename('Province/State' = 'Province.State',
         'Country/Region' = 'Country.Region') %>%
  pivot_longer(cols = -c('Province/State', 'Country/Region',Lat, Long),
               names_to = "date",
               values_to = "deaths") %>%
  mutate(date = substring(date, 2)) %>%
  mutate(date = mdy(date)) %>%
  mutate(across(where(is.character), ~ na_if(., ""))) %>%
  select(-c(Lat, Long))

global = global_cases %>%
    full_join(global_deaths) %>%
    rename(Country_Region = 'Country/Region',
          Province_State = 'Province/State')

```
Cleaning up the USA data as we did in class. Important to note a new variable added - "deaths_per_k_cases" this calculates the number of deaths per 1,000 cases of COVID-19.

```{r US clean, echo=TRUE}
US_cases = US_cases %>%
  pivot_longer(cols = -c(UID:Combined_Key),
               names_to = "date",
               values_to = "cases") %>%
  select(Admin2:cases)

US_deaths = US_deaths %>%
  pivot_longer(cols = -c(UID:Population),
               names_to = "date",
               values_to = "deaths") %>%
  select(Admin2:deaths) 

US = US_cases %>%
  full_join(US_deaths) %>%
  mutate(date = substring(date, 2)) %>%
  mutate(date = mdy(date)) %>%
  select(-c(Lat, Long_))

US_by_state = US %>%
  group_by(Province_State, Country_Region, date) %>%
  summarize(cases = sum(cases), deaths = sum(deaths),
            Population = sum(Population)) %>%
  mutate(deaths_per_100k = deaths * 100000 / Population) %>%
  mutate(deaths_per_k_cases = deaths / cases * 1000) %>%
  select(Province_State, Country_Region, date, cases, deaths, deaths_per_k_cases, deaths_per_100k, Population) %>%
  ungroup()

US_totals = US_by_state %>%
  group_by(Country_Region, date) %>%
  summarize(cases = sum(cases), deaths = sum(deaths),
            Population = sum(Population)) %>%
  mutate(deaths_per_100k = deaths * 100000 / Population) %>%
  mutate(deaths_per_k_cases = deaths / cases * 1000) %>%
  select(Country_Region, date, cases, deaths, deaths_per_k_cases, deaths_per_100k, Population) %>%
  ungroup()

```

Continuing to clean up global data as we did in class.
```{r standardize data, echo = TRUE}
global = global %>%
  unite("Combined_Key",
        c(Province_State, Country_Region),
        sep = ", ",
        na.rm = TRUE,
        remove = FALSE)

uid_lookup_url = "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/UID_ISO_FIPS_LookUp_Table.csv"

uid = read.csv(uid_lookup_url) %>%
  select(-c(Lat, Long_, UID, FIPS, Combined_Key, code3, iso2, iso3, Admin2)) %>%
  mutate(across(where(is.character), ~ na_if(., "")))

global2 = global %>%
  left_join(uid, by = c("Province_State", "Country_Region")) %>%
  select(Province_State, Country_Region, date, cases, deaths,
         Population, Combined_Key)
```

## Visualization 1
For this visualization I wanted to show how the COVID-19 death rates (deaths per 1,000 cases) compare between some select states. I chose Washington (where I live), Colorado (for CSU), Kentucky (state with highest death rate in 2023), and Hawaii (state with the lowest death rate in 2023).
```{r visualize 1, echo = TRUE}
US_by_state %>%
  filter(deaths > 200) %>%
  filter(Province_State %in% c("Washington", "Colorado", "Kentucky", "Hawaii")) %>%
  ggplot(aes(x = date, y = deaths_per_k_cases, group = Province_State, color = Province_State)) +
  geom_line() +
  scale_y_log10() +
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90)) +
  labs(title = "COVID-19 death rates in US", y = NULL)
```

## More data
Here I add some new data taken from github with the source foxnews.com. It is cleaned up and the political vote is added to my USA data.
```{r add vote data, echo = TRUE}

url_2024 = "https://raw.githubusercontent.com/tonmcg/US_County_Level_Election_Results_08-24/refs/heads/master/2024_US_County_Level_Presidential_Results.csv"
results_2024 = read.csv(url_2024)

results_2024 = results_2024%>%
  mutate(red_blue = votes_gop / votes_dem) %>%
  mutate(Admin2 = gsub("\\b County\\b", "", county_name)) %>%
  mutate(Province_State = state_name) %>%
  select(Province_State, Admin2, red_blue)

US_w_pol = US %>%
  left_join(results_2024, by = c("Admin2", "Province_State"))  %>%
  mutate(deaths_per_k_cases = deaths / cases * 1000) %>%
  filter(deaths_per_k_cases > .001) %>%
  drop_na() %>%
  filter(deaths_per_k_cases < 10000)
  
US_Blue = US_w_pol%>%
  filter(red_blue < 1) %>%
  group_by(date) %>%
  summarise(avg = mean(deaths_per_k_cases)) %>%
  mutate(Political_Vote = "DEM")

US_Red = US_w_pol %>%
  filter(red_blue > 1) %>%
  group_by(date) %>%
  summarise(avg = mean(deaths_per_k_cases)) %>%
  mutate(Political_Vote = "GOP")

DATA_RB = US_Red %>%
  full_join(US_Blue) %>%
  filter(date > as.Date("2020-05-15"))
```

## Visualization 2
This visual plots average deaths per 1,000 cases of COVID-19 per day from 2020-05-16 to 	
2023-03-09. These averages are taken by county and separated depending the majority political vote in 2024. GOP in red, DEM in blue. Interesting to look at, it appears that this could have some predictive value. This results in a time series of average death rate per 1,000 cases with two categories, GOP vote or DEM vote.
```{r visualize 2, echo = TRUE}
DATA_RB %>%
  ggplot(aes(x = date, y = avg, color = Political_Vote)) +
  geom_line() +
  scale_y_log10() +
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90)) +
  labs(title = "COVID-19 death rates in US", y = NULL) +
  scale_color_manual(values = c("DEM" = "#3443CF", "GOP" = "#CF3434"))
```

Here I calculated an average of deaths per 1,000 cases by county, resulting in the overall average deaths per 1,000 cases for each U.S. county.
```{r filter data, echo=TRUE}
avg_by_county = US_w_pol %>%
  group_by(Admin2) %>%
  mutate(avg_deaths_per_k = mean(deaths_per_k_cases)) %>%
  mutate(Political_Vote = ifelse(red_blue > 1, "GOP", "DEM")) %>%
  select(c(Province_State, red_blue, avg_deaths_per_k,
           Admin2, Political_Vote)) %>%
  distinct() %>%
  mutate(red_blue = as.numeric(red_blue))  %>%
  ungroup() %>%
  filter(avg_deaths_per_k < 10000)

```

## Generate model
Linear model predicting death rate depending on political vote. R-squared of 0.016 is not very predictive.
```{r mod 1, echo = TRUE}
mod = lm(avg_deaths_per_k ~ red_blue, data = avg_by_county)
summary(mod)
avg_by_county_mod = avg_by_county %>%
  mutate(pred = predict(mod))
```
## Model Visual

  When plotting I have binned the ratio of GOP votes per DEM vote into categories. If there are 4 or more DEM votes for each GOP vote (< 1 / 4 ratio) I have classified this as "far DEM". The other bins are made accordingly.
  Looking at this visual it appears the linear model does not fit the data very well. The means and standard deviations of each political vote category appear to be the same. I think part of this is due to the extreme variations over time. Most of the variation is due to change over time.


```{r plot mod, echo=TRUE}
avg_by_county_mod %>%
  ggplot(aes(x = red_blue, color = Political_Vote)) +
  geom_pointrange(aes(y = mean(avg_deaths_per_k),
                      ymin = mean(avg_deaths_per_k) - sd(avg_deaths_per_k),
                      ymax = mean(avg_deaths_per_k) + sd(avg_deaths_per_k),
                 x = cut(red_blue,
                             breaks = c(0, (1/4), (9/10), (10/9), (4/1), 100),
                             labels = c("far DEM", "DEM", "center", "GOP", "far GOP")))) +
  geom_line(aes(y = pred, color = "black")) +
  coord_cartesian(xlim = c(0, 6))+
  ##scale_y_log10() +
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90)) +
  labs(title = "COVID-19 death rates in US",
       y = "deaths per 1,000 cases",
       x = "political vote") +
  scale_color_manual(values = c("DEM" = "#3443CF", "GOP" = "#CF3434"))

```

Including time makes the model a bit better but r squared = 0.068 is still not good.
```{r mod 2, echo=TRUE}
mod2 = lm(deaths_per_k_cases ~ red_blue + date, data = US_w_pol)
summary(mod2)
```

## Visualization 3

Here is a histogram of death rates by county, interesting the DEM political votes have a higher density at lower rates while the GOP counties have a long tail into the higher death rates. Possibly using a non-linear model would achieve better results.
```{r histogram, echo=TRUE}
ggplot(data = avg_by_county) +
  geom_histogram(aes(x = avg_deaths_per_k, color = Political_Vote, y = after_stat(density)),
                 bins = 50) +
  scale_color_manual(values = c("DEM" = "#3443CF", "GOP" = "#CF3434"))
```

# Bias

The bias associated with this data could come from many different sources. A major source of bias could come from how COVID-19 cases and deaths are reported in different states and counties. Another factor that could skew the data is how many cases were not reported for whatever reason. Once home tests were readily available the total number of cases would probably go down. My analysis definitely could have added some bias as I removed all counties that did not have both COVID-19 data and voting data, this removed about 5% counties.

```{r info, echo = FALSE}
sessionInfo()
```
